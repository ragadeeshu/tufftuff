<!-- \<!doctype html> -->
<html>
<head>
  <title>tufftuff</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <style type="text/css">

    body {
      /*This is important for the train to look good*/
      margin: 0px;
      padding: 0px;
    }

    .Site {
      /*Footer magic*/
      display: flex;
      min-height: 100%;
      flex-direction: column;
      overflow: hidden;
    }

    .Site-content {
      /*Footer magic*/
      flex: 1;
    }

    footer {
      /*Make the train semlessly appear without the need for scrollbars*/
      overflow-x: hidden;
    }

  </style>
  
  <link rel="stylesheet" type="text/css" href="{{ static_url("style.css") }}">
  <link rel="stylesheet" type="text/css" href="{{ static_url("roundslider.css") }}">
  
  <script src="http://code.jquery.com/jquery.min.js"></script>
  
  <script src="{{ static_url("train.js") }}"></script>
  <script src="{{ static_url("roundslider.js") }}"></script>
  
<script>

  function train(){
    $("#train").text(trains[trainindex]);
    trainindex++;
    trainindex%=trains.length;
  }

  function setState(state){
    for (const type of Object.keys(state)) {
      if (type == "switch") {
        for (const id of Object.keys(state[type])) {
          var value = state[type][id]
          var direction;
          if (parseInt(id)%2) {
              direction = "left";
          } else {
              direction="right";
          }
          $("."+type+"[value='"+id+"']").data("state", value);
          $("#switch"+id+"_image").attr("src", "./static/switch_"+direction+"_"+value+".png");
        }
      } else if (type == "throttle") {
        //shift value received from 2-14 to 1-13
        var value = state[type]["1"]
        if (value < 0) {
          ++value;
        } else if (value > 0) {
          --value;
        }
        throttle.setValue(value);
      } else if (type == "lights") {
          var value = state[type]["1"]
          $('.lights').data("state", value);
          $("#lights_image").attr("src", "./static/headlight_"+value+".png");
      }
    }
  }

  // log function
  log = function(data){
    $("div#terminal").prepend("</br>" +data);
    console.log(data);
  };

  switchClick = function() {
    var value = $(this).data("state");
    if (value == 'curve')
      value = 'straight';
    else
      value = 'curve';
    switchMessage={
      "type":"switch",
      "id":$(this).val(),
      "value":value
    };
    ws.send(JSON.stringify(switchMessage));
  }

  stopClick = function() {
      //what is the difference between stop (0) and emergency stop (1)?
      throttle.setValue(0);
      throttleMessage={
          "type":"throttle",
          "id":"1",
          "value":0
      };
      ws.send(JSON.stringify(throttleMessage));
  }

  lightsClick = function() {
      var state = $('.lights').data("state")
      if (state == "off") {
          state = "on";
      } else {
          state = "off";
      }
      lightsMessage={
          "type":"lights",
          "id":"1",
          "value":state
      };
      ws.send(JSON.stringify(lightsMessage));
  }

  var throttle;
  throttleCreated = function() {
      throttle = this;
  }

  throttleChange = function(event) {
    var value = event.value;
    //"1" is emergency stop, so shift value sent from 1-13 to 2-14
    if (value < 0) {
        --value;
    } else if (value > 0) {
        ++value;
    }
    throttleMessage={
        "type":"throttle",
        "id":"1",
        "value":value
    };
    ws.send(JSON.stringify(throttleMessage));
  }

  // begin page load code
  var ws;
  $(document).ready(function () {
    $("div#controls").hide();
    $("#connection").hide();
    setInterval(train, 40);

    $('.switch').on('click', switchClick);
                    
    $('.stop').on('click', stopClick);
                    
    $('.lights').on('click', lightsClick);
                    
    $("#throttle").roundSlider({
        animation: false,
        sliderType: "min-range",
        editableTooltip: false,
        radius: 105,
        width: 16,
        min: -13,
        max: 13,
        value: 0,
        handleSize: 0,
        handleShape: "square",
        circleShape: "half-top",
        showTooltip: false,
        create: throttleCreated,
        change: throttleChange,
        drag: throttleChange
    });
    

    // Websocket stuff
    ws = new WebSocket("ws://" + window.location.host + "/ws");
    ws.onmessage = function(evt) {
      var message = JSON.parse(evt.data);
      setState(message);
    };

    ws.onclose = function(evt) {
      $("div#controls").fadeOut("slow").promise().done(
        function(){
          $("#connection").fadeIn("slow");
        }
        );
    };

    ws.onopen = function(evt) {
      $("#connection").fadeOut("slow").promise().done(
        function(){
          $("div#controls").fadeIn("slow");
        }
        );
    };
 
  }
  );
</script>
</head>

<body class="Site">
  <!-- <header><h1>tufftuff</h1></header> -->
  <main class="Site-content">
    <div id="connection_details">
      <label id="connection">NO CONNECTION<br>Wait a while, or refresh the page.</label>
    </div>
    <div id ="controls">
        <div id="switches" align="center">
            <button class="switch" value="1"><img id="switch1_image" src="./static/switch_left_straight.png" /></button>
            <button class="switch" value="2"><img id="switch2_image" src="./static/switch_right_straight.png" /></button>
            <button class="switch" value="3"><img id="switch3_image" src="./static/switch_left_straight.png" /></button>
            <button class="switch" value="4"><img id="switch4_image" src="./static/switch_right_straight.png" /></button>
        </div>
        <div id="loco" align="center">
            <button class="lights"><img id="lights_image" src="./static/headlight_on.png" height="50" width="50" /></button>
            <div class="rslider" id="throttle"></div>
            <button class="stop">STOP</button>
        </div>
    <div id="terminal">
    </div>
  </main>
  <footer><pre style="margin-bottom:0"><code id="train"></code></pre></footer>
</body>
</html>
